<!DOCTYPE html>

<!-- the Best front end code which use markdown display -->

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <title >Chatbot</title> -->
    <title >Chatbot</title>

    <!-- showdown  for markup language  -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js"></script> -->
    

    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
   
    <style>
        .container {
  max-width: calc(75vw - 75px);
  margin: 0 auto;
  padding: 20px;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0px 0px 10px #ccc;
  background-color: #fff;
  height: 725px;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  position: relative;
}
.container h1 {
  position: absolute;
  top: 0;
  left: 0;
  padding-left: 13px;
  padding-top: 5px;
}

#chatbox {
  max-height: 545px;
  overflow: auto;
}

#chat-form {
    
  display: flex;
  flex-direction: row;
  align-items: center;
  margin-top: 10px;
  
}

.form-group {
  flex: 1;
  margin-right: 10px;
  position: relative;
}

.form-group textarea {
  width: 100%;
  height: 50px;
  padding: 10px;
  border-radius: 5px;
  border: 1px solid #ccc;
  resize: none;
}

.form-group label {
  position: absolute;
  top: 50%;
  left: 10px;
  transform: translateY(-50%);
  background-color: #fff;
  padding: 0 5px;
  font-size: 14px;
  transition: all 0.2s ease;
  pointer-events: none;
}

.form-group textarea:focus + label,
.form-group textarea:not(:placeholder-shown) + label {
  transform: translateY(-85%);
  font-size: 12px;
}

.btn {
  cursor: pointer;
  background-color: #a900ff;
  border: none;
  color: #fff;
  padding: 10px 20px;
  border-radius: 5px;
  transition: all 0.2s ease;
}

.btn:hover {
  background-color: #0069d9;
}

.bot-message,
.user-message {
  max-width: 98%;
  padding: 10px;
  border-radius: 10px;
  margin-top: 10px;
  align-self: flex-start;
}

.bot-message {
  background-color: #f0f0f0;
  align-self: flex-end;
  white-space: pre-wrap;
}

.user-message {
  background-color: #cce6ff;
  align-self: flex-start;
  white-space: pre-wrap;
}

.typing-indicator {
  margin-top: 10px;
}

.typing-indicator span {
  display: inline-block;
  width: 5px;
  height: 5px;
  border-radius: 50%;
  background-color: #ccc;
  margin: 0 5px;
  animation: typing 1s linear infinite;
}

@keyframes typing {
  0% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-5px);
  }
  100% {
    transform: translateY(0);
  }
}
#chat-form button {
  display: block;
  margin-top: 10px;
}

code {
    display: inline-block;
    max-width: 98%;
    background-color: #f5f5f5;
    border-radius: 4px;
    padding: 0.2em 0.4em;
    font-family: monospace;
    white-space: pre-wrap;
    word-wrap: break-word;
    border: 1px solid #ddd;
  } 
  pre {
  background-color: #f7f7f7;
  border-radius: 5px;
  font-family: Consolas, 'Courier New', monospace;
  padding: 10px;
  overflow: auto;
  white-space: pre-wrap;
 
}

@media only screen and  (max-width: 1450px) {

.container {

    height: 550px;
    padding: 0px;
    margin: 9px  auto;
   
}

.form-group textarea {
    margin-left: 7px;
}
button{
    margin-right: 10px;
}
.bot-message,
.user-message {
    margin-left: 7px;
}



}

    </style> 

   
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <div class="container" >
        <h1 style="font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: #333; text-shadow: 1px 1px #ccc;">ChatGPT</h1>
        <div id="chatbox"  >
        </div>
        <form id="chat-form" >
            <div class="form-group">
                <!-- <label for="message">Type your message:</label> -->
                <!-- <input type="text" class="form-control" id="user-message" name="user_message"> -->
                
                <textarea type="text" class="form-control" id="user-message" name="user_message"></textarea>

            </div>
            <button type="submit" class="btn btn-primary" style="border-bottom-width: 00px;margin-bottom: 25px;" >Send</button>
            <button type="button" class="btn btn-danger" style="margin-bottom: 25px;margin-left: 5px;" id="stop-button">Stop</button>
        </form>
    </div>
    <!-- makrdown.js  -->
   
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script> -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script> -->
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
     
    <script>
    $(document).ready(function() {
        var stopFlag = false;

        function scrollToBottom() {
          const chatbox = document.getElementById("chatbox");
          chatbox.scrollTop = chatbox.scrollHeight;
        }

          // Call this function whenever a message is sent or received
          scrollToBottom();

// function createBotMessage(message) {
//   var typingIndicator = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
//   var botMessage = '<div class="bot-message"></div>';
//   var codeBlock = "";
//   $('#chatbox').append(typingIndicator); // add typing indicator
//   setTimeout(function() {
//     $('.typing-indicator').remove(); // remove typing indicator after delay
//     $(botMessage).appendTo('#chatbox'); // add bot message container
//     var i = 0;
//     var intervalId = setInterval(function() {
//       scrollToBottom();
//       if (i < message.length && !stopFlag) {
//         if (message.charAt(i) === "`") { // if backtick is found
//           if (message.substr(i+1, 2) === "``") { // if triple backticks are found next, display code block
//             var codeStartIndex = i + 3;
//             var codeEndIndex = message.indexOf("```", i+3);
//             if (codeEndIndex === -1) { // if closing backticks not found, treat as normal text
//               $('.bot-message:last').append(message.charAt(i));
//               i++;
//             } else { // if closing backticks found, format code block
//               var codeContent = message.substring(codeStartIndex, codeEndIndex);
//               var formattedCodeBlock = '<pre>' + codeContent + '</pre>';
//               $('.bot-message:last').append(formattedCodeBlock);
//               i = codeEndIndex + 3;
//             }
//           } else { // if single backtick found, display inline code
//             var codeStartIndex = i + 1;
//             var codeEndIndex = message.indexOf("`", i+1);
//             if (codeEndIndex === -1) { // if closing backtick not found, treat as normal text
//               $('.bot-message:last').append(message.charAt(i));
//               i++;
//             } else { // if closing backtick found, format inline code
//               var codeContent = message.substring(codeStartIndex, codeEndIndex);
//               var formattedCode = '<code>' + codeContent + '</code>';
//               $('.bot-message:last').append(formattedCode);
//               i = codeEndIndex + 1;
//             }
//           }
//         } else { // if backtick not found, append the character and continue writing
//           $('.bot-message:last').append(message.charAt(i));
//           i++;
//         }
//       } else {
//         clearInterval(intervalId); // clear interval after message is complete
//         scrollToBottom(); // scroll to bottom after message is complete
//       }
//     }, 30);
//   }, 500);
// }
// const markdownContent = document.getElementById('markdown-content').textContent;
//   const htmlContent = marked(markdownContent);
//   document.getElementById('markdown-content').innerHTML = htmlContent;

function createBotMessage(message) {
  var typingIndicator = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
  var botMessage = '<div class="bot-message"></div>';
  var codeBlock = "";
  $('#chatbox').append(typingIndicator); // add typing indicator
  setTimeout(function() {
    $('.typing-indicator').remove(); // remove typing indicator after delay
    $(botMessage).appendTo('#chatbox'); // add bot message container
    var i = 0;
    var intervalId = setInterval(function() {
      scrollToBottom();
      if (i < message.length && !stopFlag) {
        if (message.charAt(i) === "`") { // if backtick is found
          if (message.substr(i+1, 2) === "``") { // if triple backticks are found next, display code block
            var codeStartIndex = i + 3;
            var codeEndIndex = message.indexOf("```", i+3);
            if (codeEndIndex === -1) { // if closing backticks not found, treat as normal text
              $('.bot-message:last').append(message.charAt(i));
              i++;
            } else { // if closing backticks found, format code block
              var codeContent = message.substring(codeStartIndex, codeEndIndex);
              // var formattedCodeBlock = '<pre>'+'<code id="markdown-content">' + $('<div>').text(codeContent).html() + '</code>'+'</pre>';
                var formattedCodeBlock = '<pre>' + $('<div>').text(codeContent).html() + '</pre>';
              
                $('.bot-message:last').append(formattedCodeBlock);
              i = codeEndIndex + 3;
            }
          } else { // if single backtick found, display inline code
            var codeStartIndex = i + 1;
            var codeEndIndex = message.indexOf("`", i+1);
            if (codeEndIndex === -1) { // if closing backtick not found, treat as normal text
              $('.bot-message:last').append(message.charAt(i));
              i++;
            } else { // if closing backtick found, format inline code
              var codeContent = message.substring(codeStartIndex, codeEndIndex);
              var formattedCode = '<code>' + $('<div>').text(codeContent).html() + '</code>';
              $('.bot-message:last').append(formattedCode);
              i = codeEndIndex + 1;
            }
          }
        } else { // if backtick not found, append the character and continue writing
          $('.bot-message:last').append(message.charAt(i));
          i++;
        }
      } else {
        clearInterval(intervalId); // clear interval after message is complete
        scrollToBottom(); // scroll to bottom after message is complete
      }
    }, 30);
  }, 500);
}







    
        // Function to create user message
        function createUserMessage(message) {
            var userMessage = '<div class="user-message">' + message + '</div>';
            $(userMessage).appendTo('#chatbox'); // add user message container
            stopFlag = false; // clear stop flag when a new user message is created
            scrollToBottom(); // scroll to bottom after message is complete

        }
        
     
  $('#user-message').keydown(function(event) {
   
    if (event.keyCode === 13 && !event.shiftKey) {
    $('#chat-form').submit(); // submit the form
    event.preventDefault(); // prevent the default behavior of the "Enter" key
  }
  });

  // Get the current caret position in textarea
  function getCaret(el) {
    if (el.selectionStart) {
      return el.selectionStart;
    } else if (document.selection) {
      el.focus();
      var r = document.selection.createRange();
      if (r == null) {
        return 0;
      }
      var re = el.createTextRange(), rc = re.duplicate();
      re.moveToBookmark(r.getBookmark());
      rc.setEndPoint('EndToStart', re);
      return rc.text.length;
    }
    return 0;
  }

        $('#chat-form').submit(function(e) {
            e.preventDefault(); // prevent page reload on form submit
    
            var userMessage = $('#user-message').val(); // get user message from input field
            if (userMessage.trim() === '') { // check if user message is empty or contains only spaces
                return false; // do nothing if user message is empty or contains only spaces
            }
    
            // create and append user message to chatbox
            createUserMessage(userMessage);
    
            // send user message to backend for response
            $.ajax({
                url: '/chat',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({'message': userMessage}),
                success: function(response) {
                    // create bot message with typing effect and add response text to it
                    createBotMessage(response.message);
                },
                error: function(xhr) {
                    // log error message to console
                    console.log(xhr.responseText);
                }
            });
    
            // clear user message input field after submission
            $('#user-message').val('');
        });
    
        // Event listener for user input
        $('#user-input').on('keyup', function(event) {
            if (event.keyCode === 13) { // check if enter key is pressed
                handleUserInput(); // handle user input
            }
        });
    
        // Event listener for stop button
        $('#stop-button').on('click', function() {
            stopFlag = true; // set stop flag to true
        });
    
        // Initial bot message
        createBotMessage('Hi there! How can I help you today?');
    });
</script>    

  

</body>
</html>